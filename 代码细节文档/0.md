
# 数据预处理技术方案文档 (1_preprocess_data.py)

## 1. 概述与目标

本文档详细记录了针对**《C题 NIPT的时点选择与胎儿的异常判定》**所提供的附件数据，我们执行的预处理脚本 `1_preprocess_data.py` 的全部技术细节。

* **数据源**: 某地区孕妇的NIPT检测数据，以Excel文件形式提供，包含“男胎检测数据”和“女胎检测数据”两个工作表。
* **核心挑战**: 原始数据存在结构性问题，包括但不限于：(1) **纵向数据特性**：部分孕妇存在多次检测记录；(2) **格式不统一**：关键变量如“检测孕周”为文本格式；(3) **记录重杂**：存在因“一次采血多次检测”导致的同样本多重技术记录。
* **预处理目标**: 本脚本的核心目标是将原始数据转化为两个干净、结构化、可直接用于后续统计分析和机器学习建模的CSV文件 (`男胎_预处理后数据.csv` 和 `女胎_预处理后数据.csv`)。整个流程严格基于代码实现，确保每一步操作都有据可循。

---

## 2. 详细处理流程与代码实现解析

我们的预处理工作被封装在 `preprocess_core_final`函数中，该函数对男胎和女胎数据执行了完全相同的处理流水线，确保了方法的一致性。

#### (1) 阶段一：基础清洗与初始化

* **操作**:
  1. 移除了 `'序号'`和 `'末次月经'`列。
  2. 将 `'检测日期'`列的格式从 `YYYYMMDD`的数字或文本，统一转换为标准的 `datetime`对象。
  3. 将 `'检测抽血次数'`列转换为可处理缺失值的 `Int64`数值类型。
* **代码依据**: `df.drop(...)`, `pd.to_datetime(...)`, `pd.to_numeric(...)`
* **理由**: `'序号'`列无分析价值。`根据生活常识末次月经一般用来推测孕周，但是现在已经有了非常`精确的 `'检测孕周'`。统一日期和次数的数据类型是进行后续排序、分组和计算的基础。

#### (2) 阶段二：纵向数据记录的聚合

* **问题识别**: 题目明确指出存在“对某些孕妇有多次采血多次检测或一次采血多次检测的情况”。在数据层面，这体现为部分 `'孕妇代码'`和 `'检测抽血次数'`的组合存在多条记录。
* **操作**:
  1. 定义 `['孕妇代码', '检测抽血次数']`为复合主键，唯一标识一次检测事件。
  2. 剔除上述主键信息不完整的记录。
  3. 对每个检测事件（即每个唯一的复合主键）内的多条记录执行分组聚合 (`.groupby().agg()`)。
  4. 聚合规则依据 `cols_to_average`列表设定：对所有数值型测量指标（如身高、体重、Z值、浓度、GC含量、读段数比例等），取**均值 (`mean`)**；对其余描述性信息，取**第一个非空值 (`first`)**。
* **代码依据**: `df.dropna(subset=group_keys, ...)`, `df.groupby(group_keys, as_index=False).agg(agg_dict)`
* **理由**: 该步骤是处理本题数据纵向特性的核心。通过对技术重复的测量值取均值，我们可以有效降低单次测量的随机误差，获得对该次检测事件更稳健的估计。`2_visualize_data_final_v2.py`中的**“图1: 技术重复处理效果对比”**，通过对比处理前后男胎数据的总行数，直观地展示了此聚合操作的必要性与效果。

#### (3) 阶段三：时序基准的建立与校正

* **问题识别**: 要分析指标随时间的变化，必须确保每个孕妇的检测记录按时间正确排序，且检测次序标识无误。
* **操作**:
  1. **时序排序**: 严格按照 `'孕妇代码'`和 `'检测日期'`对数据进行升序排序。
  2. **序列标识符校正**: 基于排序后的数据，通过 `groupby('孕妇代码').cumcount() + 1`生成一个绝对正确的计算序次 `'计算序次'`。将其与原始的 `'检测抽血次数'`进行比对，若不一致，则用计算出的新序次覆盖原始数据。
  3. **标准化时间特征构建**: 新增 `'距首次检测天数'`特征，计算每次检测距离该孕妇首次检测的天数。
* **代码依据**: `df.sort_values(...)`, `df.groupby(...).cumcount()`, `(df['检测日期'] - df.groupby(...).transform('min')).dt.days`
* **理由**: **排序**是所有纵向分析的前提。**序列校正**解决了原始数据中 `检测抽血次数`可能存在的记录错误或不连续问题，确保了时序的严谨性。**`距首次检测天数`**的构建，为所有孕妇建立了一个相对时间的统一参照系，使得跨个体的动态变化比较成为可能，是问题一、二、三中分析指标与时间关系的关键。

#### (4) 阶段四：特征工程与衍生变量构建

* **问题识别**: 原始数据中的部分变量格式不规范或信息隐藏，需要转化为可直接用于建模的数值特征。
* **操作**:
  1. **孕周数值化**: 将 `'检测孕周'`列的文本格式（如 `'13+5'`）通过 `extract_pregnancy_weeks`函数，精确转换为浮点数（如 `13.71`）。
  2. **分类变量编码**: 对 `'怀孕次数'`和 `'妊娠方式'`进行独热编码（One-Hot Encoding），生成多个二元特征列。
  3. **男胎目标变量衍生**: 根据题目“男胎的Y染色体浓度达到或高于4%...则可认为NIPT的结果是基本准确的”，创建二元特征 `'Y浓度是否达标'`（1代表达标，0代表不达标）。
  4. **女胎目标变量衍生**: 针对问题四“判定女胎是否异常”，将 `'染色体的非整倍体'`列中的文本信息（如'T21'）转换为 `'is_T13'`, `'is_T18'`, `'is_T21'`三个独立的二元特征。同时将该列的缺失值填充为 `'正常'`。
* **代码依据**: `df['检测孕周'].apply(extract_pregnancy_weeks)`, `pd.get_dummies(...)`, `(df['Y染色体浓度'] >= 0.04).astype(int)`, `df['染色体的非整倍体'].str.contains(...)`
* **理由**:
  * **孕周数值化**是后续所有回归和优化模型的基础，其分布特征在 `2_visualize_data_final_v2.py`的**“图2”**中进行了可视化展示。
  * **分类变量编码**是让机器学习模型能够处理这些非数值信息的标准步骤，其统计分布在**“图3”**和**“表1”**中有所体现。
  * **`'Y浓度是否达标'`**的构建，直接服务于问题二、三中对“最早达标时间”和“达标比例”的建模需求，其统计情况也在**“图3”**中进行了可视化。
  * **`'is_T*'`**系列特征的生成，则为问题四的分类模型准备了清晰、可用的目标变量（Ground Truth），其样本统计情况在**“图4”**中得以展示。

#### (5) 阶段五：最终规整与输出

* **操作**:
  1. 将所有浮点型数值的精度统一为两位小数。
  2. 按照预定义的逻辑顺序（基础信息、检测信息、浓度、Z值、质控、结果）对所有列进行重排。
  3. 移除女胎数据中因不含Y染色体信息而产生的全空列。
  4. 将处理完成的两个DataFrame分别保存为CSV文件。
* **代码依据**: `df.round(2)`, `df[final_cols_exist]`, `df.dropna(axis=1, how='all', ...)`
* **理由**: 此阶段确保了输出数据产品的**专业性**和**易用性**。逻辑清晰的列顺序极大地方便了后续脚本调用特定特征子集。统一精度和清理空列保证了数据的整洁，为后续所有分析任务提供了稳定可靠的数据源。

---

## 3. 结论

`1_preprocess_data.py` 脚本通过一套严谨、系统的流程，将包含纵向信息和潜在噪声的原始NIPT数据，成功转化为结构化、特征丰富的分析就绪数据集。该流程的每一步都基于对题目背景和数据特性的深刻理解，其产出直接支撑了后续的可视化探索和针对四个核心问题的数学建模。
