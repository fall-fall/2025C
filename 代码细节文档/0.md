
# 数据预处理与可视化分析技术文档

## 引言

本次数据预处理的核心目标是：将原始、复杂的NIPT检测数据，转化为结构化、高质量、可直接用于建模的数据集，为精准解答赛题提出的四个核心问题奠定坚实基础。整个流程遵循**“先探查、再清洗、后构建”**的原则，通过一系列严谨的数据处理与验证步骤，确保数据的准确性、完整性和一致性。本报告将详细阐述从数据加载到最终数据集产出的每一个技术环节。

---

## 一、 数据清洗与整合

此阶段主要目标是完成数据的标准化、格式转换和初步整合。

### 1.1 数据加载与初步探查

- **流程**: 分别加载“男胎检测数据”与“女胎检测数据”两个工作表。
- **处理方式**: 移除了与建模任务无关的“样本序号”和信息不完整的“末次月经时间”列。对原始数据进行了初步的缺失值检测，并将该检测结果作为日志输出，以记录原始数据的完整性状态。

### 1.2 缺失值处理

- **原则**: 针对不同特征的业务含义，采取差异化的处理策略。
- **处理方式**:
  - [cite_start]**`染色体的非整倍体`**: 根据题目附录的明确定义“空白即为无异常” [cite: 12]，将此列的所有缺失值（`NaN`）精准地填充为字符串“正常”。这一步操作将隐含信息明确化，是后续构建分类模型目标变量的基石。
  - **`孕妇BMI`**: 针对此列的少量缺失，我们采取了比常规填充（如均值、中位数），利用同一样本的 `身高`和 `体重`数据，通过官方公式 $BMI = \frac{体重(kg)}{身高(m)^2}$ 进行计算并回填。此方法最大限度地保证了数据的真实性和准确性。

### 1.3 重复检测样本聚合

- [cite_start]**背景**: 题目指出存在“一次采血多次检测或多次采血多次检测”的情况 [cite: 6]。
- **处理方式**: 以 `['孕妇代码', '检测抽血次数']`为唯一键进行分组。
- **聚合策略**:
  - **数值型测量指标** (如各项Z值、GC含量、染色体浓度等): 采用**均值 (`mean`)**进行聚合。理由是这些指标存在测量误差，取均值可以有效地平滑噪声，得到更稳健的测量结果。
  - **事实型状态指标** (如年龄、身高、体重等): 采用**第一个非空值 (`first`)**进行聚合。理由是这些指标在短期内保持稳定，取第一个值即可代表该次检测的状态。

### 1.4 时序校正

- **问题**: 原始数据中的 `检测抽血次数`可能存在录入错误。
- **处理方式**: 将每个孕妇的检测记录严格按照 `检测日期`进行升序排序，然后使用累积计数函数 (`cumcount`) 重新生成一个绝对准确的“计算序次”，并以此覆盖原始的 `检测抽血次数`列。
- **理由**: 确保了与时间序列相关的特征（如后续构建的 `距首次检测天数`）的绝对准确性。

---

## 二、 数据质量校验与离群点分析

此阶段旨在通过统计学方法，识别并标记数据中的潜在异常，为后续建模提供高质量的数据输入。

### 2.1 核心特征离群点检测 (IQR方法)

- **目标**: 识别并标记数据中可能由录入错误或极端情况导致的离群点。
- **选择的特征**: 根据最终分析需求，我们将检测焦点精确集中在 `年龄`、`孕妇BMI`和 `孕周`这三个核心变量上。
- **原理与方法**: 采用**IQR（四分位距）法**进行检测。该方法是一种对数据分布没有要求的、稳健的统计学方法。其原理是：计算数据的下四分位数（$Q1$）和上四分位数（$Q3$），定义正常值范围的下界为 $Q1 - 1.5 \times (Q3 - Q1)$，上界为 $Q3 + 1.5 \times (Q3 - Q1)$。任何超出此范围的数据点均被视为离群点。
- **处理方式**: 为保证数据的完整性，我们并未直接删除这些离群点，而是在数据集中新增了对应的标记列（如 `年龄_is_outlier`），其值为1表示该样本为离群点，0为正常点。这种“软删除”策略为后续建模提供了更大的灵活性，可以根据需要选择是否在模型训练中包含这些点。

### 2.2 测序质量指标探索 (GC含量)

- **目标**: 评估测序数据的整体质量。
- **处理方式**: 对关键的测序质量指标 `GC含量`进行了分布的可视化分析。
- [cite_start]**分析结论**: 经分析，`GC含量`的分布集中，虽略低于题目给出的理论参考范围下限40% [cite: 12]，但在本数据集中表现出了一致性，未发现极端异常。因此，我们做出数据驱动的判断：**不基于此项对样本进行过滤**，而是将其作为一个潜在特征保留在数据集中。

---

## 三、 特征工程

此阶段的目标是基于原始数据，构建一系列对模型预测更有价值的新特征。

### 3.1 核心目标变量构建

- [cite_start]**男胎数据 (问题二、三)**: 基于题目要求“男胎的Y染色体浓度达到或高于4%、则可认为NIPT的结果是基本准确的” [cite: 4]，我们创建了二元目标变量 `'Y浓度是否达标'`（1代表达标，0代表未达标）。
- **女胎数据 (问题四)**: 基于 `'染色体的非整倍体'`列，创建了总目标变量 `'是否异常'`（1代表任何一种非整倍体，0代表正常），以及用于细分研究的 `'is_T13'`, `'is_T18'`, `'is_T21'`三个独热码特征。

### 3.2 衍生特征创建

- [cite_start]**`风险等级`**: 根据题目对风险窗口期的定义（早期12周以内风险较低；中期13-27周风险高；晚期28周以后风险极高） [cite: 4]，我们利用 `孕周`数据，创建了一个分类特征 `'风险等级'`（用1, 2, 3表示），将时间与风险直接关联。
- **`距首次检测天数`**: 为存在多次检测的孕妇，计算了每次检测距离其首次检测的天数。这是一个关键的时序特征，可用于分析指标随时间的变化趋势。

### 3.3 分类变量数值化 (独热编码)

- **目标**: 将模型无法直接处理的文本分类变量（如 `怀孕次数`、`生产次数`）转换为数值形式。
- **方法**: 采用**独热编码 (One-Hot Encoding)**。例如，将 `怀孕次数`这一列，转换为 `怀孕次数_1`、`怀孕次数_2`、`怀孕次数_≥3`等多个二元（0或1）特征列，每个新特征代表一个原始类别。

---

## 四、 模型适配处理

此阶段主要为特定的机器学习模型进行针对性的数据转换。

### 4.1 特征缩放 (标准化)

- **目标**: 此操作**仅针对用于问题四（女胎异常判定）的女胎数据**。
- **理由**: 诸如逻辑回归、SVM等分类模型，对输入特征的尺度非常敏感。若不进行缩放，数值范围大的特征（如 `原始读段数`，量级可达$10^7$）将会不成比例地主导模型训练，而数值范围小的特征（如Z值，量级在个位数）的影响力则会被削弱。
- **方法**: 采用**标准化（Standardization）**，即使用 `StandardScaler`。其原理是将每一列特征都转换为均值为0，标准差为1的标准正态分布。转换公式为：$z = \frac{x - \mu}{\sigma}$，其中 $\mu$ 是均值，$\sigma$ 是标准差。
- **稳健性处理**: 在执行标准化之前，代码会自动移除所有数值完全相同（零方差）的无用特征，并对数据中可能残存的极少量缺失值以中位数进行填充，确保了缩放过程的稳定与准确。

---

## 五、 可视化分析验证

生成了一系列图表，用于验证和展示上述每一个关键处理步骤的有效性。

- **图1-核心特征分布**: 展示了数据集中 `年龄`、`孕妇BMI`和 `孕周`三个核心变量的整体分布形态，为后续分析提供了宏观视角。
- **图2-聚合效果对比**: 通过“处理前vs处理后”的孕妇检测次数对比，直观展示了 `groupby().agg()`操作是如何将重复检测记录合并为有效检测记录的。
- **图3-IQR离群点分析**: 本次数据清洗的核心证据。通过小提琴图与散点图的结合，不仅清晰展示了 `年龄`、`孕妇BMI`、`孕周`的数据分布，还明确标记出了根据IQR准则被判定为“离群点”的样本，使得离群点的识别过程完全透明化。
- **图4-GC含量分布探索**: 展示了关键测序质量指标 `GC含量`的分布情况。如图所示，其分布形态良好，为我们“不基于此进行数据过滤”的决策提供了数据支持。
- **图5-染色体异常类型分布**: 针对问题四的目标变量，此图清晰地展示了正常样本与各类异常样本（T13, T18, T21）的数量分布。可以看出，这是一个典型的数据不平衡问题，为后续选择合适的模型评估指标（如精确率、召回率）和处理方法（如设置 `class_weight='balanced'`）提供了依据。
- **图6-所有数值特征缩放效果对比**: 直观展示了特征缩放的强大作用。图中清晰地对比了女胎数据中所有数值型特征在缩放前后的分布变化。缩放前，各特征量纲差异巨大；缩放后，所有特征都被统一到了相似的尺度下，为机器学习模型的稳定训练做好了准备。

---

## 六、 最终产出

预处理流程最终生成两个高度结构化、干净且包含丰富衍生特征的CSV文件：

1. **`男胎-预处理后数据.csv`**: 未经特征缩放，保留了所有数值的真实物理意义，专门用于问题一、二、三的回归、聚类和优化分析。
2. **`女胎-预处理后数据.csv`**: 经过特征缩放，所有预测特征被标准化，专门用于问题四的机器学习分类任务。
