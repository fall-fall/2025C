# 数据预处理与可视化分析技术文档 (最终版)

## 引言

本次数据预处理的核心目标是：将原始、复杂的NIPT检测数据，转化为结构化、高质量、可直接用于建模的数据集，为精准解答赛题提出的四个核心问题奠定坚实基础。整个流程遵循**“先探查、再清洗、后构建”**的原则，通过一系列严谨的数据处理与验证步骤，确保数据的准确性、完整性和一致性。本报告将详细阐述从数据加载到最终数据集产出的每一个技术环节，并结合可视化图表对关键步骤的有效性进行验证。

---

## 一、 数据加载与初步清洗

此阶段主要目标是完成数据的标准化、格式转换，并对数据集建立宏观认识。

- **操作流程**: 分别加载“男胎检测数据”与“女胎检测数据”两个工作表。对加载的原始数据进行全面的缺失值扫描并打印日志，以记录原始数据的完整性状态。随后，移除了与建模任务无直接用途的 `序号`和信息不完整的 `末次月经`列。（末次经期的删除理由是有缺失值，而且这个数据一般用来推测孕周时间，但是实际数据已经有了完整的‘检测孕周’这一列，没有存在的价值）
- **理由**: 这是数据处理的起点，旨在将数据读入内存并进行初步简化。在操作前进行缺失值检测，是为了完整记录原始数据的状态，确保所有处理步骤都有据可查，这是严谨建模的必要环节。

---

## 二、 核心变量格式转换与计算

此阶段旨在将关键的原始特征转化为可用于计算和分析的标准化数值格式。

- **操作流程**:

  1. **日期格式化**: 将 `检测日期`列从纯数字格式（如 `20230429`）转换为标准的日期时间对象。
  2. **孕周数值化**: 使用健壮的转换函数，将文本格式的 `检测孕周`（兼容 `12w+3`、`12w`多种格式）统一转换为可计算的浮点数（如 `12.43`）。
  3. **BMI智能计算**: 针对 `孕妇BMI`列中的缺失值，利用同一条记录的 `身高`和 `体重`数据，通过官方公式 $BMI = \frac{体重(kg)}{身高(m)^2}$ 进行精确计算和回填。
- **理由**:

  - 日期格式化是进行时间排序和计算时间间隔（如 `距首次检测天数`）的前提。
  - 孕周数值化是将一个关键的自变量从文本转换为连续数值，使其能参与后续的统计分析与建模。
  - 相比于使用均值或中位数等统计量进行填充，利用已有数据进行精确计算是处理缺失BMI最高保真度的方法，最大限度地保证了数据的真实性。
- **可视化分析一：核心特征分布**

  - **对应图表**: `图1_核心特征分布.png`
  - [cite_start]**图表说明**: 该图表展示了经过上述基础清洗和计算后，数据集中三个核心连续变量——`年龄`、`孕妇BMI`和 `孕周`的整体分布情况。它为我们提供了对样本群体特征的宏观认识，例如孕妇的年龄构成、BMI是否符合题目描述的“大多为高BMI”的地区特征 [cite: 6]，以及NIPT检测主要集中的孕周区间。此图是后续所有分析的基线。

---

## 三、 样本聚合与时序校正

此阶段旨在处理重复检测的样本，并确保数据的时序准确性。

- **操作流程**: 以 `['孕妇代码', '检测抽血次数']`为唯一键进行分组，对重复检测记录进行聚合（测量指标取均值，状态指标取第一个值）。随后，根据 `检测日期`对每个孕妇的记录重新排序并校正 `检测抽血次数`，确保其严格递增。
- [cite_start]**理由**: 题目明确指出存在重复检测的情况 [cite: 6]，聚合是消除数据冗余的必要步骤，取均值可以有效平滑单次检测的随机误差。时序校正保证了后续时序相关分析（如 `距首次检测天数`）的准确性。
- **可视化分析二：聚合效果对比**
  - **对应图表**: `图2_聚合效果对比.png`
  - **图表说明**: 此图通过“处理前vs处理后”的孕妇检测次数对比，直观展示了聚合操作的有效性。左图显示了原始数据中每个孕妇的样本记录数，而右图则显示了聚合后每个孕妇的有效检测次数。清晰地表明了数据是如何从包含大量技术重复的原始状态，被清洗为每个时间点只有唯一一条记录的规范状态。

---

## 四、 数据质量控制与离群点处理

此阶段旨在通过统计学方法，识别并处理数据中的潜在异常，为后续建模提供高质量的数据输入。

#### **4.1 核心变量离群点分析 (IQR方法)**

- **操作流程**: 对 `年龄`、`孕妇BMI`和 `孕周`这三个核心特征执行IQR检验。
- **处理方式**: 将识别出的离群点进行“软标记”，即在数据集中新增 `_is_outlier`列（1代表离群点，0代表正常点），而不直接删除。
- **理由**: 这些特征的离群点可能代表了真实存在的极端情况或数据录入错误。采用“软标记”为后续建模提供了更大的灵活性——我们可以根据需要选择在模型中包含或排除这些点，以测试模型的稳健性。
- **可视化分析 (离群点)**:
  - **对应图表**: `图3_IQR离群点分析.png`
  - **图表说明**: 此图清晰地展示了对这三个特征进行离群点分析的过程。每个子图通过小提琴图展示了数据的分布，并用散点覆盖的方式，以**红色圆点**明确标记出所有被标准IQR准则判定为“离群点”的样本，使得离群点的识别过程完全透明化。

#### **4.2 GC含量质量控制 (IQR + 条件删除)**

- **操作流程**:
  1. **识别离群点**: 对 `GC含量`列执行标准的 `1.5倍IQR`检验，识别出所有统计学上的离群点。
  2. **执行条件删除**: 对**上一步识别出的离群点**，应用业务规则进行**二次筛选**，仅将其中**数值低于40%**的样本从数据集中**直接删除（离群点且低于40%**。
- [cite_start]**理由**: 这是一个结合了统计学检验和题意的精细化处理。`GC含量`是衡量测序质量的关键指标 [cite: 12]。此方法旨在精准剔除那些不仅在统计上异常、且低于业务经验常规下限的、最有可能影响结果准确性的低质量测序样本。
- **可视化分析 (GC含量)**:
  - **对应图表**: `图4_GC含量离群点分析.png`
  - **图表说明**: 该图为GC含量的处理提供了完整的可视化证据。图中以直方图展示了 `GC含量`的整体分布，并用一条**红色虚线**明确标示出通过 $Q1 - 1.5 \times IQR$ 计算出的**左侧离群点边界**。边界左侧的“离群点范围”用红色表示，右侧的“正常范围”用蓝色表示，实现了清晰的“蓝红分离”风格，直观地展示了被删除的数据范围。

---

## 五、 特征工程与模型适配

此阶段的目标是基于清洗后的数据，构建一系列对模型预测更有价值的新特征，并为特定模型进行数据转换。

#### **5.1 目标变量与衍生特征构建**

- **操作流程**:
  - [cite_start]**目标变量**: 为男胎数据创建 `'Y浓度是否达标'`（基于题目定义的4%阈值 [cite: 4][cite_start]）；为女胎数据创建 `'是否异常'`及 `is_T13/18/21`等分类目标（基于 `染色体的非整倍体`列，“空白即为无异常”的定义 [cite: 12]）。
  - [cite_start]**衍生特征**: 创建了与题目风险定义直接相关的 `'风险等级'`特征（早期<12周, 中期13-27周, 晚期>28周 [cite: 4]），以及用于时序分析的 `'距首次检测天数'`。同时，对 `怀孕次数`、`生产次数`等文本分类特征进行了独热编码。
- **理由**: 将原始数据转化为能够直接回答赛题问题、并能被机器学习模型有效利用的格式。
- **可视化分析 (目标变量)**:
  - **对应图表**: `图5_染色体异常类型分布.png`
  - **图表说明**: 此图针对问题四的核心目标变量，直观地展示了正常样本与各类异常样本的数量。从图中可以清晰地看到，这是一个典型的**数据不平衡**问题（正常样本远多于异常样本），这一结论直接指导我们后续在建模时需要采用合适的评估指标（如精确率、召回率）和处理技巧（如在模型中设置 `class_weight='balanced'`）。

#### **5.2 特征缩放 (标准化)**

- **操作流程**: **仅针对女胎数据**的所有数值型预测特征应用了 `StandardScaler`进行标准化处理。
- **理由**: 这是为问题四的机器学习分类模型所做的关键准备。标准化（$z = \frac{x - \mu}{\sigma}$）将所有特征转换到同一尺度，避免了模型的训练过程被 `原始读段数`等具有极大数值范围的特征所主导，从而使模型能够更稳定、更公平地学习所有特征的贡献。男胎数据因其主要用于回归和优化分析，保留其原始数值的物理意义更为重要，故不进行缩放。
- **可视化分析 (特征缩放)**:
  - **对应图表**: `图6_特征缩放效果对比_4x4.png`
  - **图表说明**: 该图以4x4网格布局，详尽地展示了女胎数据中所有数值型预测变量在缩放前后的分布对比。每个子图通过双Y轴清晰地呈现了同一个特征在处理前（冷色1，数值范围各异）和处理后（冷色2，均以0为中心）的分布形态。这强有力地证明了特征缩放的必要性和有效性，是保证后续分类模型性能的关键一步。

---

## 六、 最终产出

预处理流程最终生成两个高度结构化、干净且特征丰富的CSV文件：

1. **`男胎_预处理后数据.csv`**: 未经特征缩放，保留了所有数值的真实物理意义，专门用于问题一、二、三的回归、聚类和优化分析。
2. **`女胎_预处理后数据.csv`**: 经过特征缩放，所有预测特征被标准化，专门用于问题四的机器学习分类任务。
